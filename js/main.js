(()=>{var X={pdfjs:{workerSrc:"https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js",renderingQueue:{viewsPerQueue:10,cacheExpirationTime:3e4},webGLOptions:{enableWebGL:!0,maxTextureSize:8192,imageRendering:!0}},zoom:{min:.1,max:10,default:1,renderDelay:50,smoothSteps:5},rendering:{progressive:!0,preload:!0,preloadPages:2,viewportMargin:2}},D=X;var L=class{constructor(e,t,s){this.pdfDocument=e,this.pdfjsLib=t,this.renderCallback=s,this.visiblePages=new Set,this.renderQueue=[],this.isRendering=!1,this.renderedPages=new Set,this.canvasPool=[],this.maxCanvasPoolSize=20,this.observer=null,this.setupIntersectionObserver()}setupIntersectionObserver(){this.observer=new IntersectionObserver(e=>{e.forEach(t=>{let s=parseInt(t.target.getAttribute("data-page"));t.isIntersecting?(this.visiblePages.add(s),this.queuePageRender(s)):this.visiblePages.delete(s)})},{root:document.getElementById("pdf-container"),rootMargin:"200px 0px",threshold:.1})}observePages(){document.querySelectorAll(".page-container").forEach(t=>{this.observer.observe(t)})}async queuePageRender(e){this.renderQueue.includes(e)||(this.renderQueue.push(e),this.isRendering||this.processRenderQueue())}async processRenderQueue(){if(this.renderQueue.length===0){this.isRendering=!1;return}this.isRendering=!0;let e=this.renderQueue.shift();if(this.visiblePages.has(e)&&this.renderCallback)try{await this.renderCallback(e),this.renderedPages.add(e)}catch(t){console.error(`Error rendering page ${e}:`,t)}requestAnimationFrame(()=>this.processRenderQueue())}resetRenderStatus(){this.renderedPages.clear(),this.renderQueue=[]}getCanvas(){return this.canvasPool.length>0?this.canvasPool.pop():document.createElement("canvas")}recycleCanvas(e){if(e)if(this.canvasPool.length<this.maxCanvasPoolSize){let t=e.getContext("2d");t.clearRect(0,0,e.width,e.height),t.setTransform(1,0,0,1,0,0),this.canvasPool.push(e)}else e.width=1,e.height=1,e.remove()}optimizeCanvasRendering(e){let t=e.getContext("2d",{alpha:!0,desynchronized:!0});return e.style.transform="translateZ(0)",e.style.backfaceVisibility="hidden",t}cleanupResources(){this.observer&&this.observer.disconnect(),this.visiblePages.clear(),this.renderedPages.clear(),this.renderQueue=[],this.canvasPool=[]}};var T=class{constructor(e=1){this.scale=e,this.minScale=D.zoom.min,this.maxScale=D.zoom.max,this.baseWidth=0}updateDisplay(e){document.getElementById("zoom-level").textContent=`${Math.round(e*100)}%`}setBaseDimensions(e){this.baseWidth=e}applyTemporaryZoom(e,t,s=null){let a=document.querySelector(".pdf-container"),o=document.querySelector(".pages-wrapper");if(!this.baseWidth){let d=o.style.transform;o.style.transform="none",this.baseWidth=o.offsetWidth,o.style.transform=d}let r=a.clientWidth,n=this.baseWidth*e,c=0,i=a.scrollLeft,l=a.scrollTop;if(n<r){if(c=(r-n)/2,i=0,s){let d=e/t;l=(a.scrollTop+s.y)*d-s.y}}else{if(c=0,!s){let h=a.getBoundingClientRect();s={x:h.width/2,y:h.height/2}}let d=e/t;i=(a.scrollLeft+s.x)*d-s.x,l=(a.scrollTop+s.y)*d-s.y}o.style.transform=`translate(${c}px, 0px) scale(${e})`,a.scrollLeft=i,a.scrollTop=l}calculateNewScale(e,t=null){let s=t!==null?t:this.scale*e;return s=Math.round(s*100)/100,Math.min(Math.max(s,this.minScale),this.maxScale)}};var M=class{static showMessage(e,t){let s=document.getElementById("message");s.textContent=e,s.className=`alert alert-${t==="error"?"danger":"success"}`,s.style.display="block",setTimeout(()=>s.style.display="none",3e3)}};var E=class{constructor(){this.modifications=new Map,this.currentTool=null}addModification(e,t){this.modifications.has(e)||this.modifications.set(e,[]),this.modifications.get(e).push(t)}renderModifications(e,t,s){t.getContext("2d").clearRect(0,0,t.width,t.height)}toggleTool(e){let t=document.getElementById(`${e}-btn`);document.querySelectorAll(".icon-btn").forEach(s=>s.classList.remove("active")),this.currentTool===e?this.currentTool=null:(this.currentTool=e,t&&t.classList.add("active"))}resetTool(){this.currentTool=null,document.querySelectorAll(".icon-btn").forEach(e=>e.classList.remove("active"))}};var z=class{constructor(){this.imageAnnotations=new Map}createImageAnnotation(e,t,s,a,o){let r=e.querySelector(`[data-id="${t.id}"]`);r&&r.remove();let n=document.createElement("div");n.className="image-annotation",n.setAttribute("data-id",t.id),n.style.left=`${t.x}px`,n.style.top=`${t.y}px`,n.style.width=`${t.width}px`,n.style.height=`${t.height}px`,this.setupImageElements(n,t,o,s),this.setupImageInteractions(n,t,s,a),e.appendChild(n)}setupImageElements(e,t,s,a){let o=document.createElement("img");o.src=t.data,o.style.width="100%",o.style.height="100%",t.noBackground=t.noBackground||!1,t.threshold=t.threshold||240,t.noBackground&&(o.classList.add("transparent-bg"),e.classList.add("show-threshold"),this.removeBackground(o,t)),e.appendChild(o);let r=document.createElement("div");r.className="threshold-slider-container";let n=document.createElement("input");n.type="range",n.className="threshold-slider",n.min="0",n.max="255",n.value=t.threshold,n.style.display=t.noBackground?"block":"none";let c;n.addEventListener("mousedown",h=>h.stopPropagation()),n.oninput=h=>{h.stopPropagation(),t.threshold=parseInt(h.target.value),c&&clearTimeout(c),c=setTimeout(()=>{this.removeBackground(o,t)},50)},r.appendChild(n),e.appendChild(r);let i=document.createElement("div");i.className="resize-handle",e.appendChild(i);let l=document.createElement("button");l.className="bg-toggle-btn"+(t.noBackground?" active":""),l.textContent="B",l.title="Toggle Background",l.onclick=async h=>{h.stopPropagation(),t.noBackground=!t.noBackground,t.noBackground?(l.classList.add("active"),e.classList.add("show-threshold"),n.style.display="block",await this.removeBackground(o,t)):(l.classList.remove("active"),e.classList.remove("show-threshold"),n.style.display="none",o.src=t.originalData||t.data,o.classList.remove("transparent-bg"))},e.appendChild(l);let d=document.createElement("button");d.className="delete-btn",d.textContent="\xD7",d.onclick=h=>{if(h.stopPropagation(),s){let g=s.modifications.get(a);if(g){let p=g.findIndex(y=>y.id===t.id);p>-1&&g.splice(p,1)}}e.remove()},e.appendChild(d)}async removeBackground(e,t){t.originalData||(t.originalData=t.data);let s=document.createElement("canvas"),a=s.getContext("2d");await new Promise(c=>{let i=new Image;i.onload=()=>{s.width=i.width,s.height=i.height,a.drawImage(i,0,0),c()},i.src=t.originalData});let o=a.getImageData(0,0,s.width,s.height),r=o.data;for(let c=0;c<r.length;c+=4){let i=r[c],l=r[c+1],d=r[c+2];(i+l+d)/3>t.threshold&&(r[c+3]=0)}a.putImageData(o,0,0);let n=s.toDataURL("image/png");e.src=n,t.data=n,e.classList.add("transparent-bg")}setupImageInteractions(e,t,s,a){this.setupDragHandling(e,t,a),this.setupResizeHandling(e,t,a)}setupDragHandling(e,t,s){let a=!1,o,r,n,c;e.addEventListener("mousedown",i=>{i.target.classList.contains("resize-handle")||i.target.classList.contains("delete-btn")||i.target.classList.contains("bg-toggle-btn")||i.target.closest(".threshold-slider-container")||(a=!0,o=i.clientX,r=i.clientY,n=parseFloat(e.style.left)||0,c=parseFloat(e.style.top)||0,e.style.cursor="move",i.preventDefault())}),document.addEventListener("mousemove",i=>{if(!a)return;let l=(i.clientX-o)/s,d=(i.clientY-r)/s,h=n+l,g=c+d;t.x=h,t.y=g,e.style.left=`${h}px`,e.style.top=`${g}px`}),document.addEventListener("mouseup",()=>{a&&(a=!1,e.style.cursor="default")})}setupResizeHandling(e,t,s){let a=e.querySelector(".resize-handle");a.onmousedown=o=>{o.stopPropagation(),o.preventDefault();let r=parseFloat(e.style.width),n=parseFloat(e.style.height),c=t.aspectRatio,i=o.clientX,l=o.clientY,d=g=>{let p=(g.clientX-i)/s,y=(g.clientY-l)/s,u,v;Math.abs(p)>Math.abs(y)?(u=r+p,v=u/c):(v=n+y,u=v*c);let m=20;u>m&&v>m&&(t.width=u,t.height=v,e.style.width=`${u}px`,e.style.height=`${v}px`)},h=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",h)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",h)}}};var I=class{constructor(){this.isDrawing=!1,this.currentPath=[],this.paths=new Map}startDrawing(e,t,s){this.isDrawing=!0,this.currentPath=[{x:e,y:t}]}addPoint(e,t){if(!this.isDrawing)return;let s=this.currentPath[this.currentPath.length-1],a=e-s.x,o=t-s.y;return a*a+o*o>4?(this.currentPath.push({x:e,y:t}),!0):!1}stopDrawing(e){this.isDrawing&&(this.isDrawing=!1,this.currentPath.length>1&&(this.paths.has(e)||this.paths.set(e,[]),this.paths.get(e).push([...this.currentPath])),this.currentPath=[])}drawActivePath(e,t){if(this.currentPath.length<2)return;let s=e.getContext("2d"),a=Math.min(window.devicePixelRatio||1,2),o=c=>c*t*a;s.lineCap="round",s.lineJoin="round",s.strokeStyle="#000080",s.lineWidth=2*t*a;let r=this.currentPath[this.currentPath.length-2],n=this.currentPath[this.currentPath.length-1];s.beginPath(),s.moveTo(o(r.x),o(r.y)),s.lineTo(o(n.x),o(n.y)),s.stroke()}renderDrawings(e,t,s){let a=t.getContext("2d"),o=Math.min(window.devicePixelRatio||1,2);a.lineCap="round",a.lineJoin="round",a.strokeStyle="#000080",a.lineWidth=2*s*o,(this.paths.get(e)||[]).forEach(n=>{this.drawPath(a,n,s,o)}),this.isDrawing&&this.currentPath.length>0&&this.drawPath(a,this.currentPath,s,o)}drawPath(e,t,s,a){if(t.length<2)return;let o=r=>r*s*a;e.beginPath(),e.moveTo(o(t[0].x),o(t[0].y));for(let r=1;r<t.length;r++)e.lineTo(o(t[r].x),o(t[r].y));e.stroke()}};var C=class{constructor(){}createTextAnnotation(e,t,s,a,o){let r=e.querySelector(`[data-id="${t.id}"]`);r&&r.remove();let n=document.createElement("div");n.className="text-annotation",n.setAttribute("data-id",t.id);let c=(t.fontSize||16)*a;n.style.left=`${t.x}px`,n.style.top=`${t.y}px`,n.style.fontSize=`${c}px`,n.style.lineHeight="1.2";let i=document.createElement("div");i.className="text-content",i.innerText=t.text,i.style.whiteSpace="pre",n.appendChild(i);let l=document.createElement("button");l.className="delete-btn",l.innerHTML='<i class="bi bi-x"></i>',l.onclick=h=>{h.stopPropagation();let g=o.modifications.get(s),p=g.findIndex(y=>y.id===t.id);p>-1&&g.splice(p,1),n.remove()},n.appendChild(l);let d=document.createElement("div");d.className="resize-handle",n.appendChild(d),e.appendChild(n),this.setupInteractions(n,i,t,a)}setupInteractions(e,t,s,a){e.onmousedown=r=>{if(r.target.classList.contains("resize-handle")||r.target.classList.contains("delete-btn")||t.isContentEditable)return;r.preventDefault();let n=r.clientX,c=r.clientY,i=parseFloat(e.style.left),l=parseFloat(e.style.top),d=g=>{let p=(g.clientX-n)/a,y=(g.clientY-c)/a,u=i+(g.clientX-n),v=l+(g.clientY-c);e.style.left=`${u}px`,e.style.top=`${v}px`,s.x=u,s.y=v},h=()=>{document.removeEventListener("mousemove",d),document.removeEventListener("mouseup",h)};document.addEventListener("mousemove",d),document.addEventListener("mouseup",h)};let o=e.querySelector(".resize-handle");o.onmousedown=r=>{r.stopPropagation(),r.preventDefault();let n=r.clientY,c=s.fontSize||16,i=d=>{let g=1+(d.clientY-n)/200,p=Math.max(8,c*g);p=Math.min(100,p),s.fontSize=p,e.style.fontSize=`${p*a}px`},l=()=>{document.removeEventListener("mousemove",i),document.removeEventListener("mouseup",l)};document.addEventListener("mousemove",i),document.addEventListener("mouseup",l)},e.ondblclick=r=>{r.stopPropagation(),t.contentEditable=!0,t.focus(),e.classList.add("editing");let n=document.createRange();n.selectNodeContents(t);let c=window.getSelection();c.removeAllRanges(),c.addRange(n);let i=()=>{t.contentEditable=!1,e.classList.remove("editing"),s.text=t.innerText,window.getSelection().removeAllRanges()};t.onblur=i,t.onkeydown=l=>{l.key==="Enter"&&!l.shiftKey&&(l.preventDefault(),t.blur())}}}};var R=class{constructor(e){this.onSave=e,this.modal=null,this.drawCanvas=null,this.ctx=null,this.isDrawing=!1,this.uploadedImage=null,this.activeTab="draw"}open(){this.modal||this.createModal(),this.modal.style.display="flex",this.resetCanvas(),this.switchTab("draw")}close(){this.modal&&(this.modal.style.display="none")}createModal(){let e=document.createElement("div");e.className="signature-modal-overlay",e.innerHTML=`
            <div class="signature-modal">
                <div class="modal-header">
                    <h3>Create Signature</h3>
                    <button class="close-btn">&times;</button>
                </div>
                
                <div class="modal-tabs">
                    <button class="tab-btn active" data-tab="draw">Draw</button>
                    <button class="tab-btn" data-tab="upload">Upload Image</button>
                </div>

                <div class="modal-body">
                    <div id="tab-draw" class="tab-content active">
                        <div class="canvas-wrapper">
                            <canvas id="sign-pad"></canvas>
                            <div class="canvas-placeholder">Sign here</div>
                        </div>
                        <button class="clear-btn">Clear</button>
                    </div>

                    <div id="tab-upload" class="tab-content">
                        <div class="upload-area" id="drop-zone">
                            <i class="bi bi-cloud-upload"></i>
                            <p>Click or Drop Signature Image</p>
                            <input type="file" id="sig-file-input" accept="image/*" hidden>
                        </div>
                        <div class="preview-area" style="display:none;">
                            <canvas id="preview-canvas"></canvas>
                            
                            <div class="controls">
                                <label>Remove Background</label>
                                <input type="checkbox" id="remove-bg-check" checked>
                                <div class="slider-group" id="threshold-group">
                                    <span>Threshold</span>
                                    <input type="range" id="bg-threshold" min="0" max="255" value="200">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn-cancel">Cancel</button>
                    <button class="btn-apply">Apply Signature</button>
                </div>
            </div>
        `,document.body.appendChild(e),this.modal=e,this.setupListeners(e)}setupListeners(e){e.querySelectorAll(".tab-btn").forEach(n=>{n.onclick=()=>this.switchTab(n.dataset.tab)}),e.querySelector(".close-btn").onclick=()=>this.close(),e.querySelector(".btn-cancel").onclick=()=>this.close();let t=e.querySelector("#sign-pad");this.drawCanvas=t,this.ctx=t.getContext("2d"),this.setupDrawingPad(t),e.querySelector(".clear-btn").onclick=()=>this.resetCanvas();let s=e.querySelector("#drop-zone"),a=e.querySelector("#sig-file-input");s.onclick=()=>a.click(),a.onchange=n=>this.handleFile(n.target.files[0]),s.ondragover=n=>{n.preventDefault(),s.classList.add("dragover")},s.ondragleave=()=>s.classList.remove("dragover"),s.ondrop=n=>{n.preventDefault(),s.classList.remove("dragover"),n.dataTransfer.files[0]&&this.handleFile(n.dataTransfer.files[0])};let o=e.querySelector("#bg-threshold"),r=e.querySelector("#remove-bg-check");o.oninput=()=>this.updatePreview(),r.onchange=n=>{e.querySelector("#threshold-group").style.opacity=n.target.checked?"1":"0.5",this.updatePreview()},e.querySelector(".btn-apply").onclick=()=>this.handleSave()}setupDrawingPad(e){let t=window.devicePixelRatio||1,s=e.getBoundingClientRect();e.width=s.width*t,e.height=s.height*t,this.ctx.scale(t,t),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.lineWidth=3,this.ctx.strokeStyle="#000000";let a=!1,o=c=>{a=!0,this.ctx.beginPath();let{x:i,y:l}=this.getPos(c,e);this.ctx.moveTo(i,l),this.modal.querySelector(".canvas-placeholder").style.display="none"},r=c=>{if(!a)return;c.preventDefault();let{x:i,y:l}=this.getPos(c,e);this.ctx.lineTo(i,l),this.ctx.stroke()},n=()=>a=!1;e.addEventListener("mousedown",o),e.addEventListener("mousemove",r),e.addEventListener("mouseup",n),e.addEventListener("touchstart",o,{passive:!1}),e.addEventListener("touchmove",r,{passive:!1}),e.addEventListener("touchend",n)}getPos(e,t){let s=t.getBoundingClientRect(),a=e.touches?e.touches[0].clientX:e.clientX,o=e.touches?e.touches[0].clientY:e.clientY;return{x:a-s.left,y:o-s.top}}switchTab(e){this.activeTab=e,this.modal.querySelectorAll(".tab-btn").forEach(t=>t.classList.toggle("active",t.dataset.tab===e)),this.modal.querySelectorAll(".tab-content").forEach(t=>t.classList.toggle("active",t.id===`tab-${e}`)),e==="draw"&&this.resetCanvas()}resetCanvas(){let e=this.drawCanvas.parentElement;this.drawCanvas.style.width="100%",this.drawCanvas.style.height="100%";let t=window.devicePixelRatio||1,s=this.drawCanvas.getBoundingClientRect();this.drawCanvas.width=s.width*t,this.drawCanvas.height=s.height*t,this.ctx.scale(t,t),this.ctx.lineCap="round",this.ctx.lineJoin="round",this.ctx.lineWidth=3,this.modal.querySelector(".canvas-placeholder").style.display="block"}handleFile(e){if(!e)return;let t=new FileReader;t.onload=s=>{let a=new Image;a.onload=()=>{this.uploadedImage=a,this.modal.querySelector("#drop-zone").style.display="none",this.modal.querySelector(".preview-area").style.display="block",this.updatePreview()},a.src=s.target.result},t.readAsDataURL(e)}updatePreview(){if(!this.uploadedImage)return;let e=this.modal.querySelector("#preview-canvas"),t=e.getContext("2d"),s=this.modal.querySelector("#remove-bg-check").checked,a=parseInt(this.modal.querySelector("#bg-threshold").value),r=Math.min(1,400/this.uploadedImage.width);if(e.width=this.uploadedImage.width*r,e.height=this.uploadedImage.height*r,t.drawImage(this.uploadedImage,0,0,e.width,e.height),s){let n=t.getImageData(0,0,e.width,e.height),c=n.data;for(let i=0;i<c.length;i+=4)(c[i]+c[i+1]+c[i+2])/3>a&&(c[i+3]=0);t.putImageData(n,0,0)}}handleSave(){let e;this.activeTab==="draw"?e=this.drawCanvas:e=this.modal.querySelector("#preview-canvas");let t=this.trimCanvas(e),s=t.toDataURL("image/png"),a=t.width/t.height;this.onSave(s,a),this.close()}trimCanvas(e){let t=e.getContext("2d"),s=e.width,a=e.height,r=t.getImageData(0,0,s,a).data,n=null,c=null,i=null,l=null,d,h;for(let b=0;b<r.length;b+=4)r[b+3]!==0&&(d=b/4%s,h=Math.floor(b/4/s),n===null&&(n=h),c===null&&(c=h),i===null&&(i=d),l===null&&(l=d),h<n&&(n=h),h>c&&(c=h),d<i&&(i=d),d>l&&(l=d));if(n===null){let b=document.createElement("canvas");return b.width=1,b.height=1,b}let g=10,p=Math.max(0,n-g),y=Math.max(0,i-g),u=Math.min(a,c+g),m=Math.min(s,l+g)-y,f=u-p,w=document.createElement("canvas");return w.width=m,w.height=f,w.getContext("2d").drawImage(e,y,p,m,f,0,0,m,f),w}};pdfjsLib.GlobalWorkerOptions.workerSrc=D.pdfjs.workerSrc;var B=class{constructor(){this.pdfDoc=null,this.pdfBytes=null,this.fileName="document.pdf",this.pageCanvases=new Map,this.renderTasks=new Map,this.pendingRenderTimeout=null,this.zoomManager=new T,this.modManager=new E,this.imageManager=new z,this.drawingManager=new I,this.textManager=new C,this.performanceManager=new L(this.pdfDoc,pdfjsLib,e=>{let t=document.querySelector(`.page-container[data-page="${e}"]`);t&&this.renderPageAtScale(e,t)}),this.signatureModal=new R((e,t)=>{this.activateSignaturePlacement(e,t)}),this.setupListeners()}setupListeners(){this.setupFileHandling(),this.setupToolbar(),this.setupZoomControls()}setupFileHandling(){document.getElementById("upload-btn").onclick=()=>document.getElementById("file-input").click(),document.getElementById("file-input").onchange=e=>this.handleFileUpload(e)}setupToolbar(){document.getElementById("text-btn").onclick=()=>this.modManager.toggleTool("text"),document.getElementById("image-btn").onclick=()=>this.modManager.toggleTool("image"),document.getElementById("draw-btn").onclick=()=>{this.modManager.resetTool(),this.signatureModal.open()},document.getElementById("save-btn").onclick=()=>this.savePDF()}setupZoomControls(){document.getElementById("zoom-in").onclick=()=>this.smoothZoom(1.1),document.getElementById("zoom-out").onclick=()=>this.smoothZoom(.9),this.setupWheelZoom(),this.setupPinchZoom(),this.setupKeyboardZoom()}setupWheelZoom(){let e=document.getElementById("pdf-container");e.addEventListener("wheel",t=>{if(t.ctrlKey||t.metaKey){t.preventDefault();let s=e.getBoundingClientRect(),a={x:t.clientX-s.left,y:t.clientY-s.top},r=(t.deltaY||t.detail||t.wheelDelta)>0?.9:1.1;this.smoothZoom(r,a)}},{passive:!1})}setupPinchZoom(){let e=document.getElementById("pdf-container"),t=new Hammer(e);t.get("pinch").set({enable:!0});let s=1;t.on("pinchstart",()=>{s=this.zoomManager.scale,this.zoomManager.isZooming=!0}),t.on("pinch",a=>{let o=s*a.scale;this.zoomManager.updateDisplay(o),this.zoomManager.applyTemporaryZoom(o,s,null)}),t.on("pinchend",()=>{this.zoomManager.isZooming=!1,this.smoothZoom(1,null,this.zoomManager.scale)})}setupKeyboardZoom(){document.addEventListener("keydown",e=>{(e.ctrlKey||e.metaKey)&&(e.key==="="||e.key==="+"?(e.preventDefault(),this.smoothZoom(1.1)):e.key==="-"?(e.preventDefault(),this.smoothZoom(.9)):e.key==="0"&&(e.preventDefault(),this.smoothZoom(1,null,1)))})}async handleFileUpload(e){let t=e.target.files[0];if(!t)return;this.fileName=t.name,this.cleanup();let s=await t.arrayBuffer();this.pdfBytes=new Uint8Array(s),this.modManager.modifications.clear(),this.imageManager.imageAnnotations.clear(),this.drawingManager.paths.clear(),this.zoomManager.scale=1,this.zoomManager.updateDisplay(1),await this.loadPDF(),this.smoothZoom(1,null,1),document.getElementById("save-btn").disabled=!1,M.showMessage("PDF loaded successfully","success")}async loadPDF(){let e=pdfjsLib.getDocument({data:this.pdfBytes,useSystemFonts:!0});this.pdfDoc=await e.promise;let t=document.getElementById("pdf-container");t.innerHTML="";let s=document.createElement("div");s.className="pages-wrapper",s.style.transformOrigin="0 0",t.appendChild(s);let o=(await this.pdfDoc.getPage(1)).getViewport({scale:1}),r=o.width,n=o.height;for(let c=1;c<=this.pdfDoc.numPages;c++){let i=document.createElement("div");i.className="page-container",i.setAttribute("data-page",c),i.style.width=`${r}px`,i.style.height=`${n}px`,i.classList.add("pending-render"),s.appendChild(i),this.setupPageInteractions(i,c)}this.zoomManager.setBaseDimensions(s.offsetWidth),this.performanceManager.observePages(),this.zoomManager.applyTemporaryZoom(this.zoomManager.scale,this.zoomManager.scale,null),s.classList.add("loaded"),this.renderPagesAtCurrentScale()}async renderPagesAtCurrentScale(){if(this.zoomManager.isZooming)return;this.pendingRenderTimeout&&clearTimeout(this.pendingRenderTimeout);for(let[s,a]of this.renderTasks)a.cancel();this.renderTasks.clear();let e=this.getVisiblePageNumbers(),t=document.querySelectorAll(".page-container");for(let s of t){let a=parseInt(s.getAttribute("data-page"));this.updatePageDimensions(s,a),e.includes(a)?await this.renderPageAtScale(a,s):s.classList.add("pending-render")}}updatePageDimensions(e,t){let s=this.zoomManager.scale,a=e.querySelector("canvas:not(.canvas-layer)")}async renderPageAtScale(e,t){try{let s=this.renderTasks.get(e);s&&(s.cancel(),this.renderTasks.delete(e));let a=await this.pdfDoc.getPage(e),o=a.getViewport({scale:1}),r=Math.min(window.devicePixelRatio||1,2),n=this.zoomManager.scale,c=o.width,i=o.height;t.style.width=`${c}px`,t.style.height=`${i}px`;let l=t.querySelector("canvas:not(.canvas-layer)");l&&(this.performanceManager.recycleCanvas(l),l.remove());let d=this.performanceManager.getCanvas();d.width=Math.floor(c*r*n),d.height=Math.floor(i*r*n),d.style.width=`${c}px`,d.style.height=`${i}px`,d.style.display="block";let h=this.performanceManager.optimizeCanvasRendering(d);h.setTransform(1,0,0,1,0,0),h.scale(r*n,r*n);let g={canvasContext:h,viewport:a.getViewport({scale:1})};t.style.transform="none";let p=a.render(g);this.renderTasks.set(e,p),await p.promise,this.renderTasks.delete(e),t.insertBefore(d,t.firstChild),this.setupAnnotationLayer(t,d),this.renderAnnotations(e,t)}catch(s){s.name!=="RenderingCancelledException"&&console.error(`Error rendering page ${e}:`,s),this.renderTasks.delete(e)}}getVisiblePageNumbers(){let e=[],s=document.getElementById("pdf-container").getBoundingClientRect(),a=100;return document.querySelectorAll(".page-container").forEach(o=>{let r=o.getBoundingClientRect(),n=parseInt(o.getAttribute("data-page"));r.bottom>s.top-a&&r.top<s.bottom+a&&e.push(n)}),e}setupAnnotationLayer(e,t){let s=e.querySelector(".canvas-layer");s||(s=document.createElement("canvas"),s.className="canvas-layer",e.appendChild(s)),s.width=t.width,s.height=t.height,s.style.width=t.style.width,s.style.height=t.style.height}renderAnnotations(e,t){let s=t.querySelector(".canvas-layer");this.modManager.renderModifications(e,s,this.zoomManager.scale),this.drawingManager.renderDrawings(e,s,this.zoomManager.scale),(this.modManager.modifications.get(e)||[]).forEach(o=>{o.type==="image"?this.imageManager.createImageAnnotation(t,o,e,this.zoomManager.scale,this.modManager):o.type==="text"&&this.textManager.createTextAnnotation(t,o,e,this.zoomManager.scale,this.modManager)})}activateSignaturePlacement(e,t){M.showMessage("Click anywhere on the document to place signature","success"),document.body.style.cursor="crosshair";let s=a=>{let o=a.target.closest(".page-container");if(!o)return;a.preventDefault(),a.stopPropagation();let r=parseInt(o.getAttribute("data-page")),n=o.getBoundingClientRect(),c=this.zoomManager.scale,i=a.clientX-n.left,l=a.clientY-n.top,d=150,h=d/t,g=i-d/2,p=l-h/2,y={type:"image",id:Date.now().toString(),x:g/c,y:p/c,width:d/c,height:h/c,data:e,aspectRatio:t,noBackground:!1};this.modManager.addModification(r,y),this.imageManager.createImageAnnotation(o,y,r,c,this.modManager),document.body.style.cursor="default"};setTimeout(()=>{document.addEventListener("click",s,{once:!0})},100)}smoothZoom(e,t=null,s=null){let a=this.zoomManager.scale,o=this.zoomManager.calculateNewScale(e,s);o!==a&&(this.zoomManager.scale=o,this.zoomManager.updateDisplay(o),this.zoomManager.applyTemporaryZoom(o,a,t),this.pendingRenderTimeout&&clearTimeout(this.pendingRenderTimeout),this.pendingRenderTimeout=setTimeout(()=>{this.renderPagesAtCurrentScale()},400))}cleanup(){for(let[e,t]of this.renderTasks)t.cancel();this.renderTasks.clear(),this.pendingRenderTimeout&&clearTimeout(this.pendingRenderTimeout)}setupPageInteractions(e,t){e.onmousedown=s=>this.handlePointerDown(s,e,t),e.ontouchstart=s=>this.handlePointerDown(s,e,t),e.onclick=async s=>{if(!(this.isDragging||!this.modManager.currentTool||s.target.classList.contains("image-annotation")||s.target.classList.contains("text-annotation")||s.target.closest(".text-annotation")||s.target.closest(".image-annotation"))&&["text","image"].includes(this.modManager.currentTool)){let a=e.getBoundingClientRect(),o=s.clientX-a.left,r=s.clientY-a.top;this.modManager.currentTool==="text"?await this.handleTextAdd(o,r,t):this.modManager.currentTool==="image"&&await this.handleImageAdd(o,r,t)}}}handlePointerDown(e,t,s){if(this.modManager.currentTool!=="draw")return;e.type==="touchstart"&&e.preventDefault();let a=t.getBoundingClientRect(),o=this.zoomManager.scale,r=l=>{let d=l.touches?l.touches[0].clientX:l.clientX,h=l.touches?l.touches[0].clientY:l.clientY;return{x:(d-a.left)/o,y:(h-a.top)/o}},n=r(e);this.drawingManager.startDrawing(n.x,n.y,s),this.isDragging=!0;let c=l=>{l.preventDefault();let d=r(l);if(this.drawingManager.addPoint(d.x,d.y)){let g=t.querySelector(".canvas-layer");this.drawingManager.drawActivePath(g,o)}},i=()=>{this.drawingManager.stopDrawing(s),this.isDragging=!1,document.removeEventListener("mousemove",c),document.removeEventListener("mouseup",i),document.removeEventListener("touchmove",c),document.removeEventListener("touchend",i)};document.addEventListener("mousemove",c),document.addEventListener("mouseup",i),document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",i)}async handleTextAdd(e,t,s){let a={type:"text",id:Date.now().toString(),x:e/this.zoomManager.scale,y:t/this.zoomManager.scale,text:"Double click to edit",fontSize:16};this.modManager.addModification(s,a);let o=document.querySelector(`[data-page="${s}"]`);this.textManager.createTextAnnotation(o,a,s,this.zoomManager.scale,this.modManager),this.modManager.resetTool()}async handleImageAdd(e,t,s){let a=document.createElement("input");a.type="file",a.accept="image/*",a.onchange=async o=>{let r=o.target.files[0];if(r){let n=new FileReader;n.onload=c=>{let i=new Image;i.onload=()=>{let d=i.naturalWidth,h=i.naturalHeight;(d>200||h>200)&&(d>h?(h=h/d*200,d=200):(d=d/h*200,h=200));let g=d/this.zoomManager.scale,p=h/this.zoomManager.scale,y=e/this.zoomManager.scale,u=t/this.zoomManager.scale,v=y-g,m=u-p,f={type:"image",x:v,y:m,data:c.target.result,width:g,height:p,aspectRatio:d/h,id:Date.now().toString()};this.modManager.addModification(s,f);let w=document.querySelector(`[data-page="${s}"]`);this.imageManager.createImageAnnotation(w,f,s,this.zoomManager.scale,this.modManager),this.modManager.resetTool()},i.src=c.target.result},n.readAsDataURL(r)}},a.click()}async optimizeImage(e,t,s){return new Promise(a=>{let o=new Image;o.onload=()=>{if(o.width<=t&&o.height<=s){a(e);return}let r=document.createElement("canvas");r.width=t,r.height=s;let n=r.getContext("2d");n.imageSmoothingEnabled=!0,n.imageSmoothingQuality="high",n.drawImage(o,0,0,t,s),e.startsWith("data:image/png")?a(r.toDataURL("image/png")):a(r.toDataURL("image/jpeg",.8))},o.src=e})}async savePDF(){let{PDFDocument:e,rgb:t,degrees:s}=PDFLib,a=await e.load(this.pdfBytes),o=a.getPages(),r=new Map;for(let[i,l]of this.modManager.modifications){let d=o[i-1],{width:h,height:g}=d.getSize(),y=(d.getRotation().angle||0)%360;for(let u of l)if(u.type==="text"){let v=u.fontSize||16,m,f;switch(y){case 90:m=u.y,f=u.x;break;case 180:m=h-u.x,f=u.y;break;case 270:m=h-u.y,f=g-u.x;break;default:m=u.x,f=g-u.y;break}d.drawText(u.text,{x:m,y:f-v*.8,size:v,color:t(0,0,0),rotate:s(y)})}else if(u.type==="image"){let v=parseFloat(u.x),m=parseFloat(u.y),f=parseFloat(u.width),w=parseFloat(u.height),b=m+w,A=v+f,P,k;switch(y){case 90:P=b,k=v;break;case 180:P=h-A,k=m;break;case 270:P=h-b,k=g-A;break;default:P=v,k=g-b;break}let S;if(r.has(u.data))S=r.get(u.data);else{let $=Math.ceil(f/72*150),W=Math.ceil(w/72*150),q=await this.optimizeImage(u.data,$,W),F=await fetch(q).then(Y=>Y.arrayBuffer());q.startsWith("data:image/png")?S=await a.embedPng(F):S=await a.embedJpg(F),r.set(u.data,S)}d.drawImage(S,{x:P,y:k,width:f,height:w,rotate:s(y)})}}for(let[i,l]of this.drawingManager.paths){let d=o[i-1],{width:h,height:g}=d.getSize(),y=(d.getRotation().angle||0)%360;for(let u of l){if(u.length<2)continue;let v=m=>{let f,w;switch(y){case 90:f=m.y,w=m.x;break;case 180:f=h-m.x,w=m.y;break;case 270:f=h-m.y,w=g-m.x;break;default:f=m.x,w=g-m.y}return{x:f,y:w}};for(let m=0;m<u.length-1;m++){let f=v(u[m]),w=v(u[m+1]);d.drawLine({start:f,end:w,thickness:2,color:t(0,0,.5),opacity:1})}}}let n=await a.save(),c=new Blob([n],{type:"application/pdf"});try{if(window.showSaveFilePicker){let l=await(await window.showSaveFilePicker({suggestedName:this.fileName,types:[{description:"PDF Document",accept:{"application/pdf":[".pdf"]}}]})).createWritable();await l.write(c),await l.close(),M.showMessage("PDF saved successfully","success")}else{let i=URL.createObjectURL(c),l=document.createElement("a");l.href=i,l.download=this.fileName,l.click(),URL.revokeObjectURL(i),M.showMessage("PDF downloaded successfully","success")}}catch(i){i.name!=="AbortError"&&(console.error(i),M.showMessage("Failed to save PDF","error"))}}};new B;})();
