(()=>{var C=Object.defineProperty;var f=(a,e)=>()=>(a&&(e=a(a=0)),e);var A=(a,e)=>{for(var t in e)C(a,t,{get:e[t],enumerable:!0})};var g,y=f(()=>{g=class a{constructor(e){if(this._headers={},this._body=null,this._multiParts=[],this._isAttachment=!1,typeof e!="object")throw new Error("invalid content for class MultiPartParser");this._lineEnding=this.getLineEnding(e);let t=this.splitHeaderFromBody(e);if(t.header){let o=new TextDecoder("utf-8").decode(t.header).split(/\n(?=[^\s])/g);for(let s of o){let i=s.indexOf(":");if(i!==-1){let c=s.substring(0,i).toLowerCase().trim(),l=s.substring(i+1).trim();this._headers[c]&&typeof this._headers[c]=="string"&&(this._headers[c]=[this._headers[c]]),this._headers[c]?this._headers[c].push(l):this._headers[c]=l}}}let n=this.getContentType(),r=this.getHeader("Content-Disposition");if(r&&r.match(/attachment/i)&&(this._isAttachment=!0),this._isAttachment)this.parseBodyApplication(t.body);else switch(n.mediaType){case"multipart":this.parseBodyMultipart(t.body,n.args);break;case"text":this.parseBodyText(t.body);break;default:this.parseBodyApplication(t.body);break}}get isAttachment(){return this._isAttachment}get contentType(){let e=this.getContentType();return e.mediaType&&e.subType?e.mediaType+"/"+e.subType:null}getContentType(){let e=this.getHeader("Content-Type");if(e){let t=e.match(/([a-z]+)\/([a-z0-9\-\.\+_]+);?((?:.|\s)*)$/i);if(t){let n=t[3]&&t[3].trim()!==""?t[3].trim():null;return{mediaType:t[1].toLowerCase(),subType:t[2].toLowerCase(),args:n}}}return{mediaType:null,subType:null,args:null}}getBody(){return this._body}getPartByContentType(e,t=null){return this.recursiveGetByContentType(this,e,t)||null}getHeader(e,t=!1,n=!1){let r=null;return this._headers[e.toLowerCase()]&&(r=this._headers[e.toLowerCase()]),r&&t&&(r=typeof r=="string"?this.decodeRfc1342(r):r.map(this.decodeRfc1342.bind(this))),r&&n&&(r=typeof r=="string"?r.replace(/\r?\n\s/g,""):r.map((o=>o.replace(/\r?\n\s/g,"")))),r}getMultiParts(){return this._multiParts}getFilename(){let e=this.getHeader("Content-Disposition"),t=e&&e.match(/filename=\"?([^"\n]+)\"?/i);if(t)return this.decodeRfc1342(t[1]);let n=this.getHeader("Content-Type"),r=n&&n.match(/name=\"?([^"\n]+)\"?/i);return r?this.decodeRfc1342(r[1]):null}decodeContent(e,t=null){let n=this.getHeader("Content-Transfer-Encoding");switch(n=n?n.toUpperCase():"BINARY",n){case"BASE64":return this.decodeBase64(e);case"QUOTED-PRINTABLE":return this.decodeQuotedPrintable(e,t);case"8BIT":case"7BIT":case"BINARY":return e}}decodeRfc1342(e){let t=new TextDecoder;return e=e.replace(/=\?([0-9a-z\-_:]+)\?(B|Q)\?(.*?)\?=/gi,((n,r,o,s)=>{let i=null;switch(o.toUpperCase()){case"B":i=this.decodeBase64(s,r);break;case"Q":i=this.decodeQuotedPrintable(s,r,!0);break;default:throw new Error('invalid string encoding "'+o+'"')}return t.decode(new Uint8Array(i))}))}decodeBase64(e,t=null){e instanceof Uint8Array&&(e=new TextDecoder().decode(e));let n=atob(e),r=n.length,o=new Uint8Array(r);for(let s=0;s<r;s++)o[s]=n.charCodeAt(s);if(t){let s=new TextDecoder(t);return new TextEncoder().encode(s.decode(o)).buffer}return o.buffer}decodeQuotedPrintable(e,t,n=!1){e instanceof Uint8Array&&(e=new TextDecoder().decode(e)),n&&(e=e.replace(/_/g," "));let r=new TextDecoder(t||"utf-8"),o=e.replace(/[\t\x20]$/gm,"").replace(/=(?:\r\n?|\n)/g,"").replace(/((?:=[a-fA-F0-9]{2})+)/g,(s=>{let i=s.substring(1).split("="),c=new Uint8Array(i.length);for(let l=0;l<i.length;l++)c[l]=parseInt(i[l],16);return r.decode(c)}));return new TextEncoder().encode(o).buffer}getBoundary(e){let t=e.match(/boundary=\"?([^"\s\n]+)\"?/i);return t?t[1]:null}recursiveGetByContentType(e,t,n){let r=e.getContentType();if(t===r.mediaType&&(!n||n===r.subType))return e;for(let o of e.getMultiParts())if(o instanceof a){let s=this.recursiveGetByContentType(o,t,n);if(s)return s}return null}getLineEnding(e){let t=new Uint8Array(e),n=0,r=0;for(let o=0;o<t.length;o++)t[o]===10&&t[o-1]===13?r++:t[o]===10&&n++;return n>0&&r>0?"mixed":n>0?"unix":r>0?"windows":"unknown"}splitHeaderFromBody(e){let t=new Uint8Array(e),n=null,r=0;for(let i=0;i<t.length;i++){if(this._lineEnding!=="unix"&&t[i]===13&&t[i+1]===10&&t[i+2]===13&&t[i+3]===10){r=4,n=i;break}if(t[i]===10&&t[i+1]===10){r=2,n=i;break}}let o=null,s=null;return n?(o=t.slice(0,n),s=t.slice(n+r)):s=t,{header:o,body:s}}parseBodyApplication(e){this._body=this.decodeContent(e,null)}parseBodyText(e){let t="utf-8",n=this.getContentType().args;n&&n.match(/charset=\"?([^"\s\n;]+)\"?/i)&&(t=n.match(/charset=\"?([^"\s\n;]+)\"?/i)[1]);let r=this.decodeContent(e,t),o=new TextDecoder;this._body=o.decode(new Uint8Array(r))}parseBodyMultipart(e,t){let n=this.getBoundary(t);if(!n)throw new Error("Boundary not found.");let r="--"+n+"--",o=this.indexOfString(e,r);if(o===-1)throw new Error("Final Boundary not found");let s=e.slice(0,o+r.length);for(let i=0;i<1e3;i++){let c="--"+n,l=this.indexOfString(s,c),d=this.indexOfString(s,c,l+1);if(l===-1||d===-1)break;l+=c.length;let h=s.slice(l,d);this._multiParts.push(new a(h)),s=s.slice(d)}}indexOfString(e,t,n=0,r="utf-8"){let o=new TextEncoder(r).encode(t);return e.findIndex(((s,i)=>{if(i<n)return!1;for(let c=0;c<o.length;c++)if(e[i+c]!==o[c])return!1;return!0}))}}});var w={};A(w,{EmlReader:()=>u});var u,b=f(()=>{y();u=class{#e=null;constructor(e){this.#e=new g(e)}getDate(){let e=this.#e.getHeader("date");return e?new Date(e):null}getSubject(){return this.#e.getHeader("subject",!0,!0)}getFrom(){return this.#e.getHeader("from",!0,!0)}getBcc(){return this.#e.getHeader("bcc",!0,!0)}getCc(){return this.#e.getHeader("cc",!0,!0)}getTo(){return this.#e.getHeader("to",!0,!0)}getReplyTo(){return this.#e.getHeader("reply-to",!0,!0)}getType(){return this.#e.getHeader("received")?"received":"sent"}getHeader(e,t=!1,n=!1){return this.#e.getHeader(e,t,n)}getAttachments(){let e=[],t=this.#e.getPartByContentType("multipart","mixed");if(t)for(let n of t.getMultiParts())n.isAttachment&&e.push({filename:n.getFilename(),contentType:n.contentType,content:n.getBody(),filesize:n.getBody().byteLength});else{let n=this.#e.getPartByContentType("application","octet-stream");n&&n.getFilename()&&e.push({filename:n.getFilename(),contentType:n.contentType,content:n.getBody(),filesize:n.getBody().byteLength})}return e}getMessageText(){let e=this.#e.getPartByContentType("text","plain");if(e&&!e.isAttachment)return e.getBody();let t=this.#e.getPartByContentType("text","html");if(t&&!t.isAttachment){let n=t.getBody(),r=n.indexOf("<body");r!==-1&&(n=n.substring(r)),n=n.replace(/<style[\s\w\W]+<\/style>/g,"");let o=document.createElement("div");return o.innerHTML=n,o.innerText.replace(/\r?\n\s+\r?\n/g,`

`).trim()}return null}getMessageHtml(){let e=this.#e.getPartByContentType("text","html");if(e&&!e.isAttachment)return e.getBody();let t=this.#e.getPartByContentType("text","plain");return t&&!t.isAttachment?t.getBody().replace(/\r?\n/g,"<br />"):null}}});var m=[],p;function E(a){return a.replace(/[^a-z0-9\s.\-_]/gi,"").replace(/\s+/g," ").trim().replace(/\s/g,"_")||"attachments"}function k(a){if(a===0)return"0 Bytes";let e=1024,t=["Bytes","KB","MB","GB","TB"],n=Math.floor(Math.log(a)/Math.log(e));return parseFloat((a/Math.pow(e,n)).toFixed(2))+" "+t[n]}window.downloadAllAttachments=async function(){let a=new JSZip,e=$("#email-subject").text()||"attachments",t=E(e);m.forEach(n=>{a.file(n.filename,n.content)});try{let n=await a.generateAsync({type:"blob",compression:"DEFLATE",compressionOptions:{level:9}}),r=URL.createObjectURL(n),o=document.createElement("a");o.href=r,o.download=`${t}_attachments.zip`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(r)}catch(n){console.error("Error creating ZIP:",n),alert("Error creating ZIP file: "+n.message)}};window.downloadAttachment=function(a,e,t){let n=m[t],r=new Blob([n.content],{type:e}),o=URL.createObjectURL(r),s=document.createElement("a");s.href=o,s.download=a,document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(o)};async function T(a){if(!a||!a.name.toLowerCase().endsWith(".eml")){$("#error-message").text("Please drop an .eml file").show();return}if(!p){$("#error-message").text("EML parser not loaded. Please check console for errors.").show();return}try{$("#error-message").hide();let e=await a.arrayBuffer(),t=new p(e);$("#email-subject").text(t.getSubject()||"(No Subject)"),$("#email-from").text(t.getFrom()||"Unknown"),$("#email-to").text(t.getTo()||"Unknown");let n=t.getDate();if(n){let d={weekday:"short",day:"2-digit",month:"short",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!0,timeZoneName:"shortOffset"},h=n.toLocaleString("en-US",d).replace(/,/g,"").replace(/(\d{2}):(\d{2}):(\d{2})/,"$1:$2:$3").replace("GMT","");$("#email-date").text(h)}else $("#email-date").text("Unknown");let r=t.getCc();r?($("#email-cc").text(r),$("#cc-container").show()):$("#cc-container").hide();let o=t.getBcc();o?($("#email-bcc").text(o),$("#bcc-container").show()):$("#bcc-container").hide();let s=t.getReplyTo();s?($("#email-reply-to").text(s),$("#reply-to-container").show()):$("#reply-to-container").hide();let i=t.getAttachments();if(m=i,i.length>0){let d=$("#attachments-list");d.empty(),i.forEach((h,B)=>{let x=k(h.filesize);d.append(`
                    <div class="attachment-item">
                        <span class="attachment-name">${h.filename}</span>
                        <span class="attachment-size">${x}</span>
                        <a href="#" class="attachment-download no-print" 
                           onclick="downloadAttachment('${h.filename}', '${h.contentType}', ${B}); return false;">
                            <i class="bi bi-download"></i>
                        </a>
                    </div>
                `)}),$("#attachments-section").show(),i.length>1?$("#download-all").show().off("click").on("click",window.downloadAllAttachments):$("#download-all").hide()}else $("#attachments-section").hide(),$("#download-all").hide();let c=t.getMessageHtml(),l=t.getMessageText();if(c){let d=c.replace(/(\r\n|\n|\r)/g,"").replace(/\s+/g," ").replace(/> +</g,"><").replace(/<br\s*\/?>/gi,"<br>").replace(/(<br>){3,}/gi,"<br><br>").trim();$("#email-content").html(d)}else if(l){let d=l.replace(/(\r\n|\n|\r)+/g,`
`).replace(/\n\s+\n/g,`

`).replace(/\s+/g," ").replace(/\n{3,}/g,`

`).trim();$("#email-content").text(d)}else $("#email-content").text("(No content)");$("#email-display").show()}catch(e){console.error("Error processing email:",e),$("#error-message").text("Error processing email: "+e.message).show()}}$(document).ready(async function(){try{p=(await Promise.resolve().then(()=>(b(),w))).EmlReader}catch(e){console.error("Error loading EmlReader:",e),$("#error-message").text("Error loading EML parser: "+e.message).show()}$(document).on("drag dragstart dragend dragover dragenter dragleave drop",function(e){e.preventDefault(),e.stopPropagation()});let a=$("#drop-zone");a.on("click",function(){let e=$('<input type="file" accept=".eml" style="display: none">');e.on("change",function(t){let n=t.target.files[0];n&&T(n)}),e.click()}),a.on("dragover dragenter",function(){$(this).addClass("drag-over")}),a.on("dragleave dragend drop",function(){$(this).removeClass("drag-over")}),a.on("drop",function(e){let t=e.originalEvent.dataTransfer.files[0];T(t)}),$("#print-button").on("click",function(){window.print()})});})();
/*
 * Copyright Â© 2023 Netas Ltd., Switzerland.
 * @author  Lukas Buchs, lukas.buchs@netas.ch
 * @license MIT
 * @date    2023-02-17
 */
