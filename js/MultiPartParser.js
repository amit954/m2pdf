(()=>{var h=class l{constructor(e){if(this._headers={},this._body=null,this._multiParts=[],this._isAttachment=!1,typeof e!="object")throw new Error("invalid content for class MultiPartParser");this._lineEnding=this.getLineEnding(e);let t=this.splitHeaderFromBody(e);if(t.header){let i=new TextDecoder("utf-8").decode(t.header).split(/\n(?=[^\s])/g);for(let s of i){let o=s.indexOf(":");if(o!==-1){let a=s.substring(0,o).toLowerCase().trim(),d=s.substring(o+1).trim();this._headers[a]&&typeof this._headers[a]=="string"&&(this._headers[a]=[this._headers[a]]),this._headers[a]?this._headers[a].push(d):this._headers[a]=d}}}let n=this.getContentType(),r=this.getHeader("Content-Disposition");if(r&&r.match(/attachment/i)&&(this._isAttachment=!0),this._isAttachment)this.parseBodyApplication(t.body);else switch(n.mediaType){case"multipart":this.parseBodyMultipart(t.body,n.args);break;case"text":this.parseBodyText(t.body);break;default:this.parseBodyApplication(t.body);break}}get isAttachment(){return this._isAttachment}get contentType(){let e=this.getContentType();return e.mediaType&&e.subType?e.mediaType+"/"+e.subType:null}getContentType(){let e=this.getHeader("Content-Type");if(e){let t=e.match(/([a-z]+)\/([a-z0-9\-\.\+_]+);?((?:.|\s)*)$/i);if(t){let n=t[3]&&t[3].trim()!==""?t[3].trim():null;return{mediaType:t[1].toLowerCase(),subType:t[2].toLowerCase(),args:n}}}return{mediaType:null,subType:null,args:null}}getBody(){return this._body}getPartByContentType(e,t=null){return this.recursiveGetByContentType(this,e,t)||null}getHeader(e,t=!1,n=!1){let r=null;return this._headers[e.toLowerCase()]&&(r=this._headers[e.toLowerCase()]),r&&t&&(r=typeof r=="string"?this.decodeRfc1342(r):r.map(this.decodeRfc1342.bind(this))),r&&n&&(r=typeof r=="string"?r.replace(/\r?\n\s/g,""):r.map((i=>i.replace(/\r?\n\s/g,"")))),r}getMultiParts(){return this._multiParts}getFilename(){let e=this.getHeader("Content-Disposition"),t=e&&e.match(/filename=\"?([^"\n]+)\"?/i);if(t)return this.decodeRfc1342(t[1]);let n=this.getHeader("Content-Type"),r=n&&n.match(/name=\"?([^"\n]+)\"?/i);return r?this.decodeRfc1342(r[1]):null}decodeContent(e,t=null){let n=this.getHeader("Content-Transfer-Encoding");switch(n=n?n.toUpperCase():"BINARY",n){case"BASE64":return this.decodeBase64(e);case"QUOTED-PRINTABLE":return this.decodeQuotedPrintable(e,t);case"8BIT":case"7BIT":case"BINARY":return e}}decodeRfc1342(e){let t=new TextDecoder;return e=e.replace(/=\?([0-9a-z\-_:]+)\?(B|Q)\?(.*?)\?=/gi,((n,r,i,s)=>{let o=null;switch(i.toUpperCase()){case"B":o=this.decodeBase64(s,r);break;case"Q":o=this.decodeQuotedPrintable(s,r,!0);break;default:throw new Error('invalid string encoding "'+i+'"')}return t.decode(new Uint8Array(o))}))}decodeBase64(e,t=null){e instanceof Uint8Array&&(e=new TextDecoder().decode(e));let n=atob(e),r=n.length,i=new Uint8Array(r);for(let s=0;s<r;s++)i[s]=n.charCodeAt(s);if(t){let s=new TextDecoder(t);return new TextEncoder().encode(s.decode(i)).buffer}return i.buffer}decodeQuotedPrintable(e,t,n=!1){e instanceof Uint8Array&&(e=new TextDecoder().decode(e)),n&&(e=e.replace(/_/g," "));let r=new TextDecoder(t||"utf-8"),i=e.replace(/[\t\x20]$/gm,"").replace(/=(?:\r\n?|\n)/g,"").replace(/((?:=[a-fA-F0-9]{2})+)/g,(s=>{let o=s.substring(1).split("="),a=new Uint8Array(o.length);for(let d=0;d<o.length;d++)a[d]=parseInt(o[d],16);return r.decode(a)}));return new TextEncoder().encode(i).buffer}getBoundary(e){let t=e.match(/boundary=\"?([^"\s\n]+)\"?/i);return t?t[1]:null}recursiveGetByContentType(e,t,n){let r=e.getContentType();if(t===r.mediaType&&(!n||n===r.subType))return e;for(let i of e.getMultiParts())if(i instanceof l){let s=this.recursiveGetByContentType(i,t,n);if(s)return s}return null}getLineEnding(e){let t=new Uint8Array(e),n=0,r=0;for(let i=0;i<t.length;i++)t[i]===10&&t[i-1]===13?r++:t[i]===10&&n++;return n>0&&r>0?"mixed":n>0?"unix":r>0?"windows":"unknown"}splitHeaderFromBody(e){let t=new Uint8Array(e),n=null,r=0;for(let o=0;o<t.length;o++){if(this._lineEnding!=="unix"&&t[o]===13&&t[o+1]===10&&t[o+2]===13&&t[o+3]===10){r=4,n=o;break}if(t[o]===10&&t[o+1]===10){r=2,n=o;break}}let i=null,s=null;return n?(i=t.slice(0,n),s=t.slice(n+r)):s=t,{header:i,body:s}}parseBodyApplication(e){this._body=this.decodeContent(e,null)}parseBodyText(e){let t="utf-8",n=this.getContentType().args;n&&n.match(/charset=\"?([^"\s\n;]+)\"?/i)&&(t=n.match(/charset=\"?([^"\s\n;]+)\"?/i)[1]);let r=this.decodeContent(e,t),i=new TextDecoder;this._body=i.decode(new Uint8Array(r))}parseBodyMultipart(e,t){let n=this.getBoundary(t);if(!n)throw new Error("Boundary not found.");let r="--"+n+"--",i=this.indexOfString(e,r);if(i===-1)throw new Error("Final Boundary not found");let s=e.slice(0,i+r.length);for(let o=0;o<1e3;o++){let a="--"+n,d=this.indexOfString(s,a),c=this.indexOfString(s,a,d+1);if(d===-1||c===-1)break;d+=a.length;let u=s.slice(d,c);this._multiParts.push(new l(u)),s=s.slice(c)}}indexOfString(e,t,n=0,r="utf-8"){let i=new TextEncoder(r).encode(t);return e.findIndex(((s,o)=>{if(o<n)return!1;for(let a=0;a<i.length;a++)if(e[o+a]!==i[a])return!1;return!0}))}};})();
/*
 * Copyright Â© 2023 Netas Ltd., Switzerland.
 * @author  Lukas Buchs, lukas.buchs@netas.ch
 * @license MIT
 * @date    2023-02-17
 */
